versions.tf
Copier le code
Hcl
terraform {
  required_version = ">= 1.5.0"

  required_providers {
    proxmox = {
      source  = "telmate/proxmox"
      version = ">= 2.9.14"
    }
  }
}
2ï¸âƒ£ variables.tf
Copier le code
Hcl
variable "pm_api_url" {}
variable "pm_api_token_id" {}
variable "pm_api_token_secret" {}
variable "ssh_public_key" {}

variable "target_node" {
  default = "proxmox2"
}

variable "bridge" {
  default = "vmbr0"
}

variable "storage" {
  default = "local"
}

variable "gateway" {
  default = "10.0.0.1"
}

variable "dns_servers" {
  default = "1.1.1.1 8.8.8.8"
}

variable "template_name" {
  default = "debian12-cloudinit"
}

variable "vms" {
  description = "Liste des VM Ã  crÃ©er"
  type = map(object({
    vmid = number
    ip   = string
  }))
}
3ï¸âƒ£ backend.tf (state local dans GitLab CI)
Copier le code
Hcl
terraform {
  backend "local" {
    path = "terraform.tfstate"
  }
}
ðŸ‘‰ Plus tard, tu pourras migrer vers un backend S3 / GitLab.
4ï¸âƒ£ main.tf (ðŸ”¥ cÅ“ur du projet)
Copier le code
Hcl
provider "proxmox" {
  pm_api_url          = var.pm_api_url
  pm_api_token_id     = var.pm_api_token_id
  pm_api_token_secret = var.pm_api_token_secret
  pm_tls_insecure     = true
}

resource "proxmox_vm_qemu" "debian_vm" {
  for_each = var.vms

  name        = each.key
  vmid        = each.value.vmid
  target_node = var.target_node
  clone       = var.template_name
  full_clone  = true
  os_type     = "cloud-init"

  cores  = 2
  memory = 2048
  scsihw = "virtio-scsi-pci"

  disk {
    slot    = 0
    size    = "20G"
    type    = "scsi"
    storage = var.storage
  }

  network {
    model  = "virtio"
    bridge = var.bridge
  }

  # IP statique via Cloud-Init
  ipconfig0 = "ip=${each.value.ip}/24,gw=${var.gateway}"
  nameserver = var.dns_servers

  ciuser  = "debian"
  sshkeys = var.ssh_public_key

  onboot = true
}



{
  "debian-vm-1" = {
    vmid = 101
    ip   = "10.0.0.21"
  }
  "debian-vm-2" = {
    vmid = 102
    ip   = "10.0.0.22"
  }
}



image:
  name: hashicorp/terraform:1.6
  entrypoint: [""]

stages:
  - validate
  - plan
  - apply

variables:
  TF_IN_AUTOMATION: "true"
  TF_INPUT: "false"

before_script:
  - cd terraform
  - terraform --version
  - terraform init

validate:
  stage: validate
  script:
    - terraform validate

plan:
  stage: plan
  script:
    - terraform plan
  artifacts:
    paths:
      - terraform/terraform.tfstate

apply:
  stage: apply
  when: manual
  script:
    - terraform apply -auto-approve




{
  "debian-vm-1": {
    "vmid": 101,
    "ip": "10.0.0.21"
  },
  "debian-vm-2": {
    "vmid": 102,
    "ip": "10.0.0.22"
  }
}




variable "pm_api_url" {}
variable "pm_api_token_id" {}
variable "pm_api_token_secret" {}
variable "ssh_public_key" {}

variable "target_node" {
  default = "proxmox2"
}

variable "bridge" {
  default = "vmbr0"
}

variable "storage" {
  default = "local"
}

variable "gateway" {
  default = "10.0.0.1"
}

variable "dns_servers" {
  default = "1.1.1.1"
}

variable "template_name" {
  default = "debian12-cloudinit"
}

variable "vms" {
  description = "Liste des VM Ã  crÃ©er"
  type = map(object({
    vmid = number
    ip   = string
  }))
}







provider "proxmox" {
  pm_api_url          = var.pm_api_url
  pm_api_token_id     = var.pm_api_token_id
  pm_api_token_secret = var.pm_api_token_secret
  pm_tls_insecure     = true
}

resource "proxmox_vm_qemu" "debian_vm" {
  for_each = var.vms

  name        = each.key
  vmid        = each.value.vmid
  target_node = var.target_node
  clone       = var.template_name
  full_clone  = true
  os_type     = "cloud-init"

  cores  = 2
  memory = 2048
  scsihw = "virtio-scsi-pci"

  disk {
    slot    = 0
    size    = "20G"
    type    = "scsi"
    storage = var.storage
  }

  network {
    model  = "virtio"
    bridge = var.bridge
  }

  ipconfig0 = "ip=${each.value.ip}/24,gw=${var.gateway}"
  nameserver = var.dns_servers

  ciuser  = "debian"
  sshkeys = var.ssh_public_key

  onboot = true
}



resource "proxmox_vm_qemu" "debian_vm" {
  for_each = var.vms

  name        = each.key
  vmid        = each.value.vmid
  target_node = var.target_node

  clone      = var.template_name
  full_clone = true
  os_type    = "cloud-init"

  cores   = 1
  sockets = 1
  memory  = 2048

  scsihw = "virtio-scsi-pci"

  disk {
    slot    = 0
    size    = "20G"
    type    = "scsi"
    storage = var.storage
  }

  network {
    model  = "virtio"
    bridge = var.bridge
  }

  # Cloud-init MINIMAL (important)
  ipconfig0 = "ip=${each.value.ip}/24,gw=${var.gateway}"
  ciuser    = "debian"
  sshkeys   = var.ssh_public_key

  onboot = true
}


terraform {
  required_version = ">= 1.5.0"

  required_providers {
    proxmox = {
      source  = "bpg/proxmox"
      version = "~> 0.55.0"
    }
  }
}




provider "proxmox" {
  endpoint  = var.pm_api_url
  api_token = "${var.pm_api_token_id}=${var.pm_api_token_secret}"

  insecure = true
}



variable "pm_api_url" {}
variable "pm_api_token_id" {}
variable "pm_api_token_secret" {}

variable "ssh_public_key" {}

variable "target_node" {
  default = "proxmox2"
}

variable "bridge" {
  default = "vmbr0"
}

variable "storage" {
  default = "local"
}

variable "gateway" {
  default = "10.0.0.1"
}

variable "template_name" {
  default = "debian12-cloudinit"
}

variable "vms" {
  type = map(object({
    vmid = number
    ip   = string
  }))
}



resource "proxmox_virtual_environment_vm" "debian_vm" {
  for_each = var.vms

  name      = each.key
  vm_id     = each.value.vmid
  node_name = var.target_node

  clone {
    vm_id = var.template_name
  }

  cpu {
    cores = 1
    type  = "host"
  }

  memory {
    dedicated = 2048
  }

  disk {
    datastore_id = var.storage
    size         = 20
    interface    = "scsi0"
  }

  network_device {
    bridge = var.bridge
  }

  initialization {
    ip_config {
      ipv4 {
        address = "${each.value.ip}/24"
        gateway = var.gateway
      }
    }

    user_account {
      username = "debian"
      keys     = [var.ssh_public_key]
    }
  }

  lifecycle {
    ignore_changes = [
      network_device,
      disk
    ]
  }
}


