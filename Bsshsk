---
- name: Installation Proxmox VE - Diagnostic et Déploiement
  hosts: proxmox
  become: true

  vars:
    # On utilise HTTPS partout pour maximiser les chances de passage
    proxmox_repo: "deb [signed-by=/usr/share/keyrings/proxmox-archive-keyring.gpg] https://download.proxmox.com/debian/pve bookworm pve-no-subscription"
    proxmox_keyring: "/usr/share/keyrings/proxmox-archive-keyring.gpg"

  tasks:
    # --- ÉTAPE 0 : DIAGNOSTIC RÉSEAU ---
    - name: "DIAGNOSTIC : Test de connexion HTTPS vers Proxmox"
      ansible.builtin.wait_for:
        host: download.proxmox.com
        port: 443
        timeout: 10
        msg: "ERREUR : Le port 443 vers Proxmox est bloqué. Vérifiez votre Pare-feu ou Bastion."

    # --- ÉTAPE 1 : RÉPARATION ET DNS ---
    - name: "Nettoyage : Débloquer DPKG si nécessaire"
      ansible.builtin.shell: |
        rm -f /var/lib/dpkg/lock-frontend
        rm -f /var/lib/apt/lists/lock
        dpkg --configure -a
      ignore_errors: yes

    - name: "Réseau : Forcer IPv4 et DNS Google"
      ansible.builtin.copy:
        dest: "{{ item.dest }}"
        content: "{{ item.content }}"
      with_items:
        - { dest: '/etc/apt/apt.conf.d/99force-ipv4', content: 'Acquire::ForceIPv4 "true";' }
        - { dest: '/etc/resolv.conf', content: "nameserver 8.8.8.8\nnameserver 1.1.1.1" }

    - name: "Réseau : Configurer /etc/hosts (Obligatoire pour Proxmox)"
      ansible.builtin.lineinfile:
        path: /etc/hosts
        line: "{{ ansible_default_ipv4.address }} {{ ansible_hostname }}.local {{ ansible_hostname }}"
        regexp: "^{{ ansible_default_ipv4.address }}"
        state: present

    # --- ÉTAPE 2 : PRÉPARATION DES DÉPÔTS ---
    - name: "Dépôts : Installer les certificats CA et Wget"
      ansible.builtin.apt:
        name: [ca-certificates, wget, gnupg, apt-transport-https]
        state: present
        update_cache: yes

    - name: "Dépôts : Ajouter la clé GPG Proxmox"
      ansible.builtin.shell: |
        wget -qO - https://download.proxmox.com/debian/proxmox-release-bookworm.gpg | gpg --dearmor -o {{ proxmox_keyring }}
      args:
        creates: "{{ proxmox_keyring }}"

    - name: "Dépôts : Configurer le fichier source Proxmox"
      ansible.builtin.copy:
        dest: /etc/apt/sources.list.d/pve-install-repo.list
        content: "{{ proxmox_repo }}"

    # --- ÉTAPE 3 : INSTALLATION ---
    - name: "Système : Mise à jour complète (dist-upgrade)"
      ansible.builtin.apt:
        upgrade: dist
        update_cache: yes

    - name: "Proxmox : Installation des paquets principaux"
      ansible.builtin.apt:
        name: [proxmox-ve, postfix, open-iscsi]
        state: present
      notify: Redémarrage final

  handlers:
    - name: Redémarrage final
      ansible.builtin.reboot:
        reboot_timeout: 600
