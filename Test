fix-proxmox-repo-and-reboot.yml


---
- name: Fix d√©p√¥t Proxmox + reboot contr√¥l√©
  hosts: proxmox
  become: true

  vars:
    reboot_enabled: true

  tasks:

    # üö® CRITIQUE : supprimer le d√©p√¥t enterprise AVANT tout apt update
    - name: Supprimer le d√©p√¥t Proxmox Enterprise (401 fix)
      file:
        path: /etc/apt/sources.list.d/pve-enterprise.list
        state: absent

    - name: Supprimer ancienne entr√©e enterprise √©ventuelle
      lineinfile:
        path: /etc/apt/sources.list
        regexp: 'enterprise\.proxmox\.com'
        state: absent

    - name: Forcer le d√©p√¥t Proxmox no-subscription
      copy:
        dest: /etc/apt/sources.list.d/pve-no-subscription.list
        content: |
          deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription
        mode: '0644'

    # ‚úÖ Maintenant seulement, on peut faire apt update
    - name: Mise √† jour APT apr√®s correction des d√©p√¥ts
      apt:
        update_cache: yes

    # üîÅ Reboot final (kernel Proxmox)
    - name: Reboot des n≈ìuds Proxmox
      when: reboot_enabled | bool
      reboot:
        msg: "Reboot post-install Proxmox (kernel + d√©p√¥ts corrig√©s)"
        reboot_timeout: 600


fix_proxmox_repo_and_reboot:
  stage: proxmox
  tags:
    - rocky
  script:
    - cd ansible
    - ansible-playbook playbooks/fix-proxmox-repo-and-reboot.yml
  when: manual


ansible/group_vars/proxmox.yml
üëâ Centralise les param√®tres du cluster (BEST PRACTICE)
Copier le code
Yaml
cluster_name: proxmox-cluster
proxmox_master_ip: 10.0.0.3
üìÑ ansible/inventory/prod.ini
Copier le code
Ini
[proxmox_master]
proxmox1 ansible_host=10.0.0.3

[proxmox_nodes]
proxmox2 ansible_host=10.0.0.4

[proxmox:children]
proxmox_master
proxmox_nodes
üìÑ ansible/playbooks/proxmox-cluster-create.yml
Copier le code
Yaml
---
- name: Cr√©ation du cluster Proxmox
  hosts: proxmox_master
  become: true

  tasks:
    - name: V√©rifier si le cluster existe d√©j√†
      command: pvecm status
      register: cluster_status
      failed_when: false
      changed_when: false

    - name: Cr√©er le cluster Proxmox
      command: pvecm create {{ cluster_name }}
      when: "'Cluster information' not in cluster_status.stdout"
üìÑ ansible/playbooks/proxmox-cluster-join.yml
Copier le code
Yaml
---
- name: Ajout des n≈ìuds au cluster Proxmox
  hosts: proxmox_nodes
  become: true

  tasks:
    - name: V√©rifier si le n≈ìud est d√©j√† dans un cluster
      command: pvecm status
      register: node_status
      failed_when: false
      changed_when: false

    - name: Rejoindre le cluster Proxmox
      command: pvecm add {{ proxmox_master_ip }} -force
      when: "'Cluster information' not in node_status.stdout"
üìÑ ansible/ansible.cfg
Copier le code
Ini
[defaults]
inventory = inventory/prod.ini
host_key_checking = False
retry_files_enabled = False
interpreter_python = auto
üöÄ .gitlab-ci.yml (rappel ‚Äî cluster stage)
Copier le code
Yaml
stages:
  - proxmox
  - cluster

create_proxmox_cluster:
  stage: cluster
  tags:
    - rocky
  script:
    - cd ansible
    - ansible-playbook playbooks/proxmox-cluster-create.yml
  when: manual

join_proxmox_cluster:
  stage: cluster
  tags:
    - rocky
  script:
    - cd ansible
    - ansible-playbook playbooks/proxmox-cluster-join.yml
  when: manual
