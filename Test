fix-proxmox-repo-and-reboot.yml


---
- name: Fix d√©p√¥t Proxmox + reboot contr√¥l√©
  hosts: proxmox
  become: true

  vars:
    reboot_enabled: true

  tasks:

    # üö® CRITIQUE : supprimer le d√©p√¥t enterprise AVANT tout apt update
    - name: Supprimer le d√©p√¥t Proxmox Enterprise (401 fix)
      file:
        path: /etc/apt/sources.list.d/pve-enterprise.list
        state: absent

    - name: Supprimer ancienne entr√©e enterprise √©ventuelle
      lineinfile:
        path: /etc/apt/sources.list
        regexp: 'enterprise\.proxmox\.com'
        state: absent

    - name: Forcer le d√©p√¥t Proxmox no-subscription
      copy:
        dest: /etc/apt/sources.list.d/pve-no-subscription.list
        content: |
          deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription
        mode: '0644'

    # ‚úÖ Maintenant seulement, on peut faire apt update
    - name: Mise √† jour APT apr√®s correction des d√©p√¥ts
      apt:
        update_cache: yes

    # üîÅ Reboot final (kernel Proxmox)
    - name: Reboot des n≈ìuds Proxmox
      when: reboot_enabled | bool
      reboot:
        msg: "Reboot post-install Proxmox (kernel + d√©p√¥ts corrig√©s)"
        reboot_timeout: 600


fix_proxmox_repo_and_reboot:
  stage: proxmox
  tags:
    - rocky
  script:
    - cd ansible
    - ansible-playbook playbooks/fix-proxmox-repo-and-reboot.yml
  when: manual
