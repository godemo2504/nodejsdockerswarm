fix-proxmox-repo-and-reboot.yml


---
- name: Fix dÃ©pÃ´t Proxmox + reboot contrÃ´lÃ©
  hosts: proxmox
  become: true

  vars:
    reboot_enabled: true

  tasks:

    # ðŸš¨ CRITIQUE : supprimer le dÃ©pÃ´t enterprise AVANT tout apt update
    - name: Supprimer le dÃ©pÃ´t Proxmox Enterprise (401 fix)
      file:
        path: /etc/apt/sources.list.d/pve-enterprise.list
        state: absent

    - name: Supprimer ancienne entrÃ©e enterprise Ã©ventuelle
      lineinfile:
        path: /etc/apt/sources.list
        regexp: 'enterprise\.proxmox\.com'
        state: absent

    - name: Forcer le dÃ©pÃ´t Proxmox no-subscription
      copy:
        dest: /etc/apt/sources.list.d/pve-no-subscription.list
        content: |
          deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription
        mode: '0644'

    # âœ… Maintenant seulement, on peut faire apt update
    - name: Mise Ã  jour APT aprÃ¨s correction des dÃ©pÃ´ts
      apt:
        update_cache: yes

    # ðŸ” Reboot final (kernel Proxmox)
    - name: Reboot des nÅ“uds Proxmox
      when: reboot_enabled | bool
      reboot:
        msg: "Reboot post-install Proxmox (kernel + dÃ©pÃ´ts corrigÃ©s)"
        reboot_timeout: 600


fix_proxmox_repo_and_reboot:
  stage: proxmox
  tags:
    - rocky
  script:
    - cd ansible
    - ansible-playbook playbooks/fix-proxmox-repo-and-reboot.yml
  when: manual


ansible/group_vars/proxmox.yml
ðŸ‘‰ Centralise les paramÃ¨tres du cluster (BEST PRACTICE)
Copier le code
Yaml
cluster_name: proxmox-cluster
proxmox_master_ip: 10.0.0.3
ðŸ“„ ansible/inventory/prod.ini
Copier le code
Ini
[proxmox_master]
proxmox1 ansible_host=10.0.0.3

[proxmox_nodes]
proxmox2 ansible_host=10.0.0.4

[proxmox:children]
proxmox_master
proxmox_nodes
ðŸ“„ ansible/playbooks/proxmox-cluster-create.yml
Copier le code
Yaml
---
- name: CrÃ©ation du cluster Proxmox
  hosts: proxmox_master
  become: true

  tasks:
    - name: VÃ©rifier si le cluster existe dÃ©jÃ 
      command: pvecm status
      register: cluster_status
      failed_when: false
      changed_when: false

    - name: CrÃ©er le cluster Proxmox
      command: pvecm create {{ cluster_name }}
      when: "'Cluster information' not in cluster_status.stdout"
ðŸ“„ ansible/playbooks/proxmox-cluster-join.yml
Copier le code
Yaml
---
- name: Ajout des nÅ“uds au cluster Proxmox
  hosts: proxmox_nodes
  become: true

  tasks:
    - name: VÃ©rifier si le nÅ“ud est dÃ©jÃ  dans un cluster
      command: pvecm status
      register: node_status
      failed_when: false
      changed_when: false

    - name: Rejoindre le cluster Proxmox
      command: pvecm add {{ proxmox_master_ip }} -force
      when: "'Cluster information' not in node_status.stdout"
ðŸ“„ ansible/ansible.cfg
Copier le code
Ini
[defaults]
inventory = inventory/prod.ini
host_key_checking = False
retry_files_enabled = False
interpreter_python = auto
ðŸš€ .gitlab-ci.yml (rappel â€” cluster stage)
Copier le code
Yaml
stages:
  - proxmox
  - cluster

create_proxmox_cluster:
  stage: cluster
  tags:
    - rocky
  script:
    - cd ansible
    - ansible-playbook playbooks/proxmox-cluster-create.yml
  when: manual

join_proxmox_cluster:
  stage: cluster
  tags:
    - rocky
  script:
    - cd ansible
    - ansible-playbook playbooks/proxmox-cluster-join.yml
  when: manual


---
- name: CrÃ©ation du cluster Proxmox
  hosts: proxmox_master
  become: true

  vars:
    cluster_name: proxmox-cluster

  tasks:
    - name: VÃ©rifier si le cluster existe dÃ©jÃ 
      command: pvecm status
      register: cluster_status
      failed_when: false
      changed_when: false

    - name: CrÃ©er le cluster Proxmox
      command: pvecm create {{ cluster_name }}
      when: "'Cluster information' not in cluster_status.stdout"



---
- name: Ajouter les nÅ“uds au cluster Proxmox
  hosts: proxmox_nodes
  become: true

  vars:
    master_ip: 10.0.0.3   # IP du proxmox1

  tasks:
    - name: VÃ©rifier si le nÅ“ud est dÃ©jÃ  dans un cluster
      command: pvecm status
      register: node_status
      failed_when: false
      changed_when: false

    - name: Rejoindre le cluster Proxmox
      command: pvecm add {{ master_ip }} -force
      when: "'Cluster information' not in node_status.stdout"





---
- name: Ajouter les nÅ“uds au cluster Proxmox
  hosts: proxmox_nodes
  become: true

  vars:
    master_ip: 10.0.0.5

  tasks:
    - name: VÃ©rifier si le nÅ“ud est dÃ©jÃ  dans un cluster
      command: pvecm status
      register: node_status
      failed_when: false
      changed_when: false

    - name: Rejoindre le cluster Proxmox (non interactif)
      command: >
        pvecm add {{ master_ip }}
        -force
        --use_ssh
      when: "'Cluster information' not in node_status.stdout"




---
- name: Rejoindre le cluster Proxmox
  hosts: proxmox_nodes
  become: true

  vars:
    master_ip: 10.0.0.5
    corosync_bind_ip: "{{ ansible_default_ipv4.address }}"

  tasks:
    - name: VÃ©rifier si le noeud est dÃ©jÃ  dans un cluster
      command: pvecm status
      register: pvecm_status
      failed_when: false
      changed_when: false

    - name: Rejoindre le cluster Proxmox
      command: >
        pvecm add {{ master_ip }}
        --use_ssh
        --force
        --link0 {{ corosync_bind_ip }}
      when: "'does not exist' in pvecm_status.stderr"
