group_vars/openstack_aio.yml
Copier le code
Yaml
atmosphere_repo: https://github.com/vexxhost/atmosphere.git
atmosphere_dir: /opt/atmosphere
üõ†Ô∏è playbook 1 ‚Äî prepare-os.yml
(OBLIGATOIRE ‚Äì 90 % des erreurs viennent d‚Äôici)
Copier le code
Yaml
- hosts: openstack_aio
  become: true
  tasks:
    - name: Update system
      apt:
        update_cache: yes
        upgrade: dist

    - name: Install base packages
      apt:
        name:
          - git
          - curl
          - wget
          - bridge-utils
          - python3-pip
          - python3-venv
          - build-essential
          - pkg-config
          - libssl-dev
          - qemu-kvm
          - libvirt-daemon-system
          - libvirt-clients
        state: present

    - name: Enable and start libvirtd
      systemd:
        name: libvirtd
        enabled: true
        state: started

    - name: Ensure br_netfilter is loaded
      modprobe:
        name: br_netfilter
        state: present

    - name: Sysctl settings for OpenStack
      sysctl:
        name: "{{ item.key }}"
        value: "{{ item.value }}"
        sysctl_set: yes
      loop:
        - { key: net.ipv4.ip_forward, value: 1 }
        - { key: net.bridge.bridge-nf-call-iptables, value: 1 }
        - { key: net.bridge.bridge-nf-call-ip6tables, value: 1 }
üì¶ playbook 2 ‚Äî install-poetry.yml
‚ö†Ô∏è PAS via pip
Copier le code
Yaml
- hosts: openstack_aio
  become: true
  tasks:
    - name: Install Poetry
      shell: |
        curl -sSL https://install.python-poetry.org | python3 -
      args:
        creates: /root/.local/bin/poetry

    - name: Add Poetry to PATH
      lineinfile:
        path: /root/.bashrc
        line: 'export PATH="$HOME/.local/bin:$PATH"'
üì• playbook 3 ‚Äî install-atmosphere.yml
Copier le code
Yaml
- hosts: openstack_aio
  become: true
  vars_files:
    - ../group_vars/openstack_aio.yml
  tasks:
    - name: Clone Atmosphere
      git:
        repo: "{{ atmosphere_repo }}"
        dest: "{{ atmosphere_dir }}"
        version: main

    - name: Install Atmosphere dependencies
      command: /root/.local/bin/poetry install --with dev
      args:
        chdir: "{{ atmosphere_dir }}"
üöÄ playbook 4 ‚Äî deploy-openstack-aio.yml
‚è±Ô∏è 30 √† 60 minutes ‚Äì NORMAL
Copier le code
Yaml
- hosts: openstack_aio
  become: true
  vars_files:
    - ../group_vars/openstack_aio.yml
  tasks:
    - name: Deploy OpenStack AIO
      command: /root/.local/bin/poetry run molecule converge -s aio
      args:
        chdir: "{{ atmosphere_dir }}"
      async: 7200
      poll: 30
ü§ñ .gitlab-ci.yml (FINAL)
Copier le code
Yaml
stages:
  - deploy

deploy-openstack:
  stage: deploy
  tags:
    - shell
  script:
    - cd ansible
    - ansible-playbook playbooks/prepare-os.yml
    - ansible-playbook playbooks/install-poetry.yml
    - ansible-playbook playbooks/install-atmosphere.yml
    - ansible-playbook playbooks/deploy-openstack-aio.yml
