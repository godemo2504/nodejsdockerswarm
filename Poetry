- name: Install system dependencies
  apt:
    name:
      - git
      - python3-pip
      - python3-venv
      - build-essential
      - libssl-dev
      - libffi-dev
    state: present
    update_cache: yes

- name: Install Poetry
  pip:
    name: poetry
    executable: pip3

- name: Clone Atmosphere
  git:
    repo: https://github.com/vexxhost/atmosphere.git
    dest: "{{ atmosphere_dir }}"
    version: main
    force: yes

- name: Disable Poetry venv (CI safe)
  shell: |
    poetry config virtualenvs.create false
  args:
    chdir: "{{ atmosphere_dir }}"

- name: Install Python deps via pip (PROD method)
  shell: |
    pip3 install -r requirements.txt || true
    pip3 install -r requirements-dev.txt || true
  args:
    chdir: "{{ atmosphere_dir }}"

- name: Run Atmosphere AIO deployment
  shell: |
    poetry run molecule converge -s aio
  args:
    chdir: "{{ atmosphere_dir }}"
