✅ Étape 1 — Préparer l’OS (OBLIGATOIRE)
playbooks/prepare-os.yml
Copier le code
Yaml
- hosts: openstack_aio
  become: true
  tasks:
    - name: Update system
      apt:
        update_cache: yes
        upgrade: dist

    - name: Install base packages
      apt:
        name:
          - git
          - curl
          - wget
          - bridge-utils
          - libvirt-daemon-system
          - libvirt-clients
          - qemu-kvm
          - python3-pip
          - python3-venv
          - build-essential
          - pkg-config
          - libssl-dev
        state: present

    - name: Enable libvirtd
      systemd:
        name: libvirtd
        enabled: true
        state: started
✅ Étape 2 — Installer Poetry PROPREMENT
❌ PAS via pip
Copier le code
Yaml
- name: Install Poetry
  shell: |
    curl -sSL https://install.python-poetry.org | python3 -
  args:
    creates: /root/.local/bin/poetry

- name: Add Poetry to PATH
  lineinfile:
    path: /root/.bashrc
    line: 'export PATH="$HOME/.local/bin:$PATH"'
✅ Étape 3 — Installer Atmosphere
Copier le code
Yaml
- name: Clone Atmosphere
  git:
    repo: https://github.com/vexxhost/atmosphere.git
    dest: /opt/atmosphere
    version: main

- name: Install Atmosphere dependencies
  command: poetry install --with dev
  args:
    chdir: /opt/atmosphere
✅ Étape 4 — Déployer OpenStack AIO (SEULEMENT ICI)
Copier le code
Yaml
- name: Deploy OpenStack AIO
  command: poetry run molecule converge -s aio
  args:
    chdir: /opt/atmosphere
  async: 7200
  poll: 30
⏱️ Ça peut prendre 30–60 minutes, c’est NORMAL.
✅ GitLab CI (corrigé)
Copier le code
Yaml
deploy-openstack:
  stage: deploy
  script:
    - ansible-playbook -i inventory/prod.ini playbooks/prepare-os.yml
    - ansible-playbook -i inventory/prod.ini playbooks/install-atmosphere.yml
    - ansible-playbook -i inventory/prod.ini playbooks/deploy-openstack.yml
