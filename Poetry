- name: Install poetry
  pip:
    name: poetry
    executable: pip3

- name: Clone Atmosphere
  git:
    repo: https://github.com/vexxhost/atmosphere.git
    dest: "{{ atmosphere_dir }}"
    version: main
    force: yes

- name: Configure Poetry for CI (disable package mode & venv)
  shell: |
    poetry config virtualenvs.create false
  args:
    chdir: "{{ atmosphere_dir }}"

- name: Install Atmosphere dependencies (CI safe)
  shell: |
    POETRY_PACKAGE_MODE=0 poetry install --no-root
  args:
    chdir: "{{ atmosphere_dir }}"

- name: Deploy OpenStack AIO
  shell: |
    POETRY_PACKAGE_MODE=0 poetry run molecule converge -s aio
  args:
    chdir: "{{ atmosphere_dir }}"
