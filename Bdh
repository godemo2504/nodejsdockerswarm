configure:
  stage: configure
  script:
    - eval "$(ssh-agent -s)"
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -

    - echo "[webservers]" > inventory.ini

    - IFS=',' read -ra IPS <<< "$VM_PRIVATE_IPS"
    - for ip in "${IPS[@]}"; do echo "$ip" >> inventory.ini; done

    - echo "" >> inventory.ini
    - echo "[webservers:vars]" >> inventory.ini
    - echo "ansible_user=debian" >> inventory.ini
    - echo "ansible_ssh_common_args='-o ProxyJump=root@$BASTION_IP'" >> inventory.ini

    - cat inventory.ini   # DEBUG IMPORTANT

    - ansible-playbook ansible/install_nginx.yml -i inventory.ini -vv

Arborescence Ansible (finale propre)
Text
Copier le code
ansible/
â”‚
â”œâ”€â”€ ansible.cfg
â”œâ”€â”€ install_nginx.yml
â”‚
â””â”€â”€ roles/
    â””â”€â”€ nginx/
        â””â”€â”€ tasks/
            â””â”€â”€ main.yml
âš ï¸ On ne met PAS dâ€™inventory statique dans le repo.
Il sera gÃ©nÃ©rÃ© dynamiquement dans le pipeline.
ðŸ“„ ansible/ansible.cfg
Ini
Copier le code
[defaults]
host_key_checking = False
retry_files_enabled = False
timeout = 30

[ssh_connection]
ssh_args = -o ForwardAgent=yes -o StrictHostKeyChecking=no
ðŸ“„ ansible/install_nginx.yml
Yaml
Copier le code
- hosts: webservers
  become: yes
  roles:
    - nginx
ðŸ“„ ansible/roles/nginx/tasks/main.yml
Yaml
Copier le code
- name: Install nginx
  apt:
    name: nginx
    state: present
    update_cache: yes

- name: Ensure nginx is running
  service:
    name: nginx
    state: started
    enabled: yes




configure:
  stage: configure
  script:
    - eval "$(ssh-agent -s)"
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -

    - mkdir -p ~/.ssh
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\tUserKnownHostsFile=/dev/null\n" > ~/.ssh/config

    - echo "[webservers]" > inventory.ini
    - IFS=',' read -ra IPS <<< "$VM_PRIVATE_IPS"
    - for ip in "${IPS[@]}"; do echo "$ip" >> inventory.ini; done

    - echo "" >> inventory.ini
    - echo "[webservers:vars]" >> inventory.ini
    - echo "ansible_user=debian" >> inventory.ini
    - echo "ansible_ssh_common_args='-o ProxyJump=root@$BASTION_IP'" >> inventory.ini

    - ansible-playbook ansible/install_nginx.yml -i inventory.ini -vv
