configure:
  stage: configure
  script:
    - eval "$(ssh-agent -s)"
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -

    - echo "[webservers]" > inventory.ini

    - IFS=',' read -ra IPS <<< "$VM_PRIVATE_IPS"
    - for ip in "${IPS[@]}"; do echo "$ip" >> inventory.ini; done

    - echo "" >> inventory.ini
    - echo "[webservers:vars]" >> inventory.ini
    - echo "ansible_user=debian" >> inventory.ini
    - echo "ansible_ssh_common_args='-o ProxyJump=root@$BASTION_IP'" >> inventory.ini

    - cat inventory.ini   # DEBUG IMPORTANT

    - ansible-playbook ansible/install_nginx.yml -i inventory.ini -vv

Arborescence Ansible (finale propre)
Text
Copier le code
ansible/
‚îÇ
‚îú‚îÄ‚îÄ ansible.cfg
‚îú‚îÄ‚îÄ install_nginx.yml
‚îÇ
‚îî‚îÄ‚îÄ roles/
    ‚îî‚îÄ‚îÄ nginx/
        ‚îî‚îÄ‚îÄ tasks/
            ‚îî‚îÄ‚îÄ main.yml
‚ö†Ô∏è On ne met PAS d‚Äôinventory statique dans le repo.
Il sera g√©n√©r√© dynamiquement dans le pipeline.
üìÑ ansible/ansible.cfg
Ini
Copier le code
[defaults]
host_key_checking = False
retry_files_enabled = False
timeout = 30

[ssh_connection]
ssh_args = -o ForwardAgent=yes -o StrictHostKeyChecking=no
üìÑ ansible/install_nginx.yml
Yaml
Copier le code
- hosts: webservers
  become: yes
  roles:
    - nginx
üìÑ ansible/roles/nginx/tasks/main.yml
Yaml
Copier le code
- name: Install nginx
  apt:
    name: nginx
    state: present
    update_cache: yes

- name: Ensure nginx is running
  service:
    name: nginx
    state: started
    enabled: yes




configure:
  stage: configure
  script:
    - eval "$(ssh-agent -s)"
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -

    - mkdir -p ~/.ssh
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\tUserKnownHostsFile=/dev/null\n" > ~/.ssh/config

    - echo "[webservers]" > inventory.ini
    - IFS=',' read -ra IPS <<< "$VM_PRIVATE_IPS"
    - for ip in "${IPS[@]}"; do echo "$ip" >> inventory.ini; done

    - echo "" >> inventory.ini
    - echo "[webservers:vars]" >> inventory.ini
    - echo "ansible_user=debian" >> inventory.ini
    - echo "ansible_ssh_common_args='-o ProxyJump=root@$BASTION_IP'" >> inventory.ini

    - ansible-playbook ansible/install_nginx.yml -i inventory.ini -vv



---
- name: Installation de Proxmox VE sur Debian 12 Bookworm
  hosts: proxmox
  become: true

  vars:
    proxmox_repo: "deb [arch=amd64] http://download.proxmox.com/debian/pve bookworm pve-no-subscription"
    proxmox_repo_file: "/etc/apt/sources.list.d/pve-install-repo.list"

    proxmox_gpg_url: "https://download.proxmox.com/debian/proxmox-release-bookworm.gpg"
    proxmox_gpg_dest: "/etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg"

    reboot_enabled: false

  tasks:

    #################################################################
    # üîµ D√©sactivation IPv6 (√©vite erreur urllib / get_url)
    #################################################################
    - name: Disable IPv6
      sysctl:
        name: net.ipv6.conf.all.disable_ipv6
        value: '1'
        state: present
        reload: yes

    #################################################################
    # üîµ Mise √† jour initiale
    #################################################################
    - name: Mise √† jour initiale du cache APT
      apt:
        update_cache: yes
        cache_valid_time: 3600

    #################################################################
    # üîµ Pr√©requis syst√®me
    #################################################################
    - name: Installer les pr√©requis syst√®me
      apt:
        name:
          - wget
          - gnupg
          - ca-certificates
        state: present

    #################################################################
    # üîµ T√©l√©charger cl√© GPG officielle
    #################################################################
    - name: T√©l√©charger la cl√© GPG Proxmox (Bookworm)
      get_url:
        url: "{{ proxmox_gpg_url }}"
        dest: "{{ proxmox_gpg_dest }}"
        mode: '0644'

    #################################################################
    # üîµ Ajouter d√©p√¥t no-subscription
    #################################################################
    - name: Ajouter le d√©p√¥t Proxmox VE no-subscription
      copy:
        dest: "{{ proxmox_repo_file }}"
        content: "{{ proxmox_repo }}\n"
        mode: '0644'

    #################################################################
    # üîµ Supprimer d√©p√¥t enterprise (si pr√©sent)
    #################################################################
    - name: Supprimer d√©p√¥t Proxmox Enterprise si existant
      file:
        path: /etc/apt/sources.list.d/pve-enterprise.list
        state: absent

    #################################################################
    # üîµ Mise √† jour apr√®s ajout repo
    #################################################################
    - name: Mettre √† jour APT apr√®s ajout d√©p√¥t Proxmox
      apt:
        update_cache: yes

    #################################################################
    # üîµ Upgrade syst√®me
    #################################################################
    - name: Mise √† jour compl√®te du syst√®me
      apt:
        upgrade: dist

    #################################################################
    # üîµ Installation Proxmox VE
    #################################################################
    - name: Installer Proxmox VE
      apt:
        name: proxmox-ve
        state: present
      notify: Maybe reboot server

  handlers:
    - name: Maybe reboot server
      when: reboot_enabled | bool
      reboot:
        msg: "Reboot requis apr√®s installation de Proxmox VE"
        reboot_timeout: 600
