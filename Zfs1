---
- name: Créer réplication ZFS (mode shell hardcodé)
  hosts: proxmox_master
  become: true

  tasks:
    - name: Vérifier si une réplication existe déjà
      ansible.builtin.command: pvesr list
      register: replication_list
      changed_when: false

    - name: Créer job de réplication ZFS (shell direct)
      ansible.builtin.shell: |
        pvesr create-local-job replica-vm100 proxmox2 --schedule */5 --rate 1
      args:
        executable: /bin/bash
      when: "'replica-vm100' not in replication_list.stdout"
      changed_when: true
