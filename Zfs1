---
- name: Créer réplication ZFS (mode shell hardcodé)
  hosts: proxmox_master
  become: true

  tasks:
    - name: Vérifier si une réplication existe déjà
      ansible.builtin.command: pvesr list
      register: replication_list
      changed_when: false

    - name: Créer job de réplication ZFS (shell direct)
      ansible.builtin.shell: |
        pvesr create-local-job replica-vm100 proxmox2 --schedule */5 --rate 1
      args:
        executable: /bin/bash
      when: "'replica-vm100' not in replication_list.stdout"
      changed_when: true



---
- name: Créer réplication ZFS (avec variables)
  hosts: proxmox_master
  become: true

  vars_files:
    - ../group_vars/proxmox.yml

  pre_tasks:
    - name: Vérifier que les variables de réplication sont définies
      ansible.builtin.assert:
        that:
          - replication is defined
          - replication.vmid is defined
          - replication.target_node is defined
          - replication.schedule is defined
          - replication.rate_limit is defined
        fail_msg: "Variables de réplication manquantes ou incomplètes dans group_vars/proxmox.yml"

  tasks:
    - name: Lister les jobs de réplication existants
      ansible.builtin.command: pvesr list
      register: replication_list
      changed_when: false

    - name: Créer le job de réplication ZFS
      ansible.builtin.shell: |
        pvesr create-local-job {{ replication.vmid }} {{ replication.target_node }} \
        --schedule "{{ replication.schedule }}" \
        --rate {{ replication.rate_limit }}
      args:
        executable: /bin/bash
      when: replication.vmid|string not in replication_list.stdout
      changed_when: true
