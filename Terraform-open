Objectif maintenant :
âœ… CrÃ©er image Debian 12
âœ… CrÃ©er network + subnet + router
âœ… CrÃ©er keypair
âœ… CrÃ©er 2 VM m1.large
âœ… Assigner Floating IP
âŒ Pas dâ€™Ansible pour le moment
ðŸ“ Arborescence minimale propre
Text
Copier le code
openstack-vm-terraform/
â”‚
â”œâ”€â”€ .gitlab-ci.yml
â”œâ”€â”€ backend.tf
â”œâ”€â”€ providers.tf
â”œâ”€â”€ variables.tf
â”œâ”€â”€ terraform.tfvars
â”‚
â”œâ”€â”€ image.tf
â”œâ”€â”€ network.tf
â”œâ”€â”€ security.tf
â”œâ”€â”€ compute.tf
â”œâ”€â”€ floating_ip.tf
â”œâ”€â”€ outputs.tf
â”‚
â””â”€â”€ terraform_key.pub
ðŸ“„ Contenu des fichiers
ðŸ”¹ backend.tf (optionnel mais recommandÃ©)
Hcl
Copier le code
terraform {
  backend "swift" {
    container = "terraform-state"
  }
}
Si tu ne veux pas encore backend distant â†’ supprime ce fichier.
ðŸ”¹ providers.tf
Hcl
Copier le code
terraform {
  required_providers {
    openstack = {
      source  = "terraform-provider-openstack/openstack"
      version = "~> 1.54"
    }
  }
}

provider "openstack" {}
Les variables OS_* doivent Ãªtre dÃ©finies dans GitLab CI.
ðŸ”¹ variables.tf
Hcl
Copier le code
variable "vm_count" {
  default = 2
}

variable "flavor_name" {
  default = "m1.large"
}
ðŸ”¹ terraform.tfvars
Hcl
Copier le code
vm_count    = 2
flavor_name = "m1.large"
ðŸ”¹ image.tf
Hcl
Copier le code
resource "openstack_images_image_v2" "debian12" {
  name             = "debian-12-terraform"
  image_source_url = "https://cloud.debian.org/images/cloud/bookworm/latest/debian-12-genericcloud-amd64.qcow2"
  container_format = "bare"
  disk_format      = "qcow2"
  visibility       = "private"
}
ðŸ”¹ network.tf
Hcl
Copier le code
data "openstack_networking_network_v2" "public" {
  name = "public"
}

resource "openstack_networking_network_v2" "net" {
  name           = "tf-net"
  admin_state_up = true
}

resource "openstack_networking_subnet_v2" "subnet" {
  name       = "tf-subnet"
  network_id = openstack_networking_network_v2.net.id
  cidr       = "192.168.100.0/24"
  ip_version = 4
}

resource "openstack_networking_router_v2" "router" {
  name                = "tf-router"
  external_network_id = data.openstack_networking_network_v2.public.id
}

resource "openstack_networking_router_interface_v2" "router_interface" {
  router_id = openstack_networking_router_v2.router.id
  subnet_id = openstack_networking_subnet_v2.subnet.id
}
ðŸ”¹ security.tf
Hcl
Copier le code
resource "openstack_networking_secgroup_v2" "ssh" {
  name = "tf-secgroup"
}

resource "openstack_networking_secgroup_rule_v2" "ssh_rule" {
  direction         = "ingress"
  ethertype         = "IPv4"
  protocol          = "tcp"
  port_range_min    = 22
  port_range_max    = 22
  security_group_id = openstack_networking_secgroup_v2.ssh.id
}
ðŸ”¹ compute.tf
âš  GÃ©nÃ¨re une clÃ© si pas encore fait :
Bash
Copier le code
ssh-keygen -t rsa -b 4096 -f terraform_key
Puis :
Hcl
Copier le code
resource "openstack_compute_keypair_v2" "key" {
  name       = "tf-keypair"
  public_key = file("terraform_key.pub")
}

resource "openstack_compute_instance_v2" "vm" {
  count       = var.vm_count
  name        = "debian12-vm-${count.index + 1}"
  image_id    = openstack_images_image_v2.debian12.id
  flavor_name = var.flavor_name
  key_pair    = openstack_compute_keypair_v2.key.name

  security_groups = [
    openstack_networking_secgroup_v2.ssh.name
  ]

  network {
    uuid = openstack_networking_network_v2.net.id
  }
}
ðŸ”¹ floating_ip.tf
Hcl
Copier le code
resource "openstack_networking_floatingip_v2" "fip" {
  count = var.vm_count
  pool  = "public"
}

resource "openstack_compute_floatingip_associate_v2" "fip_assoc" {
  count       = var.vm_count
  floating_ip = openstack_networking_floatingip_v2.fip[count.index].address
  instance_id = openstack_compute_instance_v2.vm[count.index].id
}
ðŸ”¹ outputs.tf
Hcl
Copier le code
output "floating_ips" {
  value = openstack_networking_floatingip_v2.fip[*].address
}
ðŸš€ .gitlab-ci.yml minimal
Yaml
Copier le code
image: hashicorp/terraform:1.6

stages:
  - validate
  - apply

before_script:
  - terraform init -reconfigure

validate:
  stage: validate
  script:
    - terraform validate

apply:
  stage: apply
  script:
    - terraform apply -auto-approve
  when: manual
ðŸ”¥ RÃ©sultat attendu aprÃ¨s Apply
Dans OpenStack :
âœ” Image Debian 12 privÃ©e
âœ” RÃ©seau tf-net
âœ” Router
âœ” Security group SSH
âœ” 2 VM m1.large
âœ” 2 Floating IP
âœ” SSH accessible :
Bash
Copier le code
ssh -i terraform_key debian@FLOATING_IP
ðŸŽ¯ Ã‰tape suivante logique
