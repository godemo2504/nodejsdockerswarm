---
- name: Installation de Proxmox VE sur Debian 12 Bookworm
  hosts: proxmox
  become: true

  vars:
    proxmox_repo: "deb [signed-by=/usr/share/keyrings/proxmox-archive-keyring.gpg] http://download.proxmox.com/debian/pve bookworm pve-no-subscription"
    proxmox_keyring: "/usr/share/keyrings/proxmox-archive-keyring.gpg"
    reboot_enabled: true

  tasks:
    # --- 1. SÉCURITÉ RÉSEAU & DNS ---
    - name: Force APT to use IPv4 (évite l'erreur Network Unreachable)
      ansible.builtin.copy:
        content: 'Acquire::ForceIPv4 "true";'
        dest: /etc/apt/apt.conf.d/99force-ipv4
        mode: '0644'

    - name: Configuration DNS (8.8.8.8)
      ansible.builtin.copy:
        content: |
          nameserver 8.8.8.8
          nameserver 1.1.1.1
        dest: /etc/resolv.conf
        mode: '0644'

    - name: Désactivation d'IPv6
      ansible.posix.sysctl:
        name: "{{ item }}"
        value: '1'
        state: present
        reload: yes
      with_items:
        - net.ipv6.conf.all.disable_ipv6
        - net.ipv6.conf.default.disable_ipv6

    # --- 2. CONFIGURATION HOSTNAME (CRUCIAL POUR PROXMOX) ---
    - name: Configurer /etc/hosts (l'IP doit pointer sur le hostname)
      ansible.builtin.lineinfile:
        path: /etc/hosts
        line: "{{ ansible_default_ipv4.address }} {{ ansible_hostname }}.local {{ ansible_hostname }}"
        regexp: "^{{ ansible_default_ipv4.address }}"
        state: present

    # --- 3. PRÉPARATION DES DÉPÔTS ---
    - name: Supprimer le dépôt enterprise par défaut
      ansible.builtin.file:
        path: /etc/apt/sources.list.d/pve-enterprise.list
        state: absent

    - name: Installer les prérequis (wget, gnupg)
      ansible.builtin.apt:
        name: [wget, gnupg, ca-certificates]
        state: present
        update_cache: yes

    - name: Télécharger la clé GPG Proxmox
      ansible.builtin.shell: |
        wget -qO - http://download.proxmox.com/debian/proxmox-release-bookworm.gpg \
        | gpg --dearnor -o {{ proxmox_keyring }}
      args:
        creates: "{{ proxmox_keyring }}"

    - name: Ajouter le dépôt Proxmox No-Subscription
      ansible.builtin.copy:
        dest: /etc/apt/sources.list.d/pve-install-repo.list
        content: "{{ proxmox_repo }}"
        mode: '0644'

    # --- 4. MISE À JOUR ET INSTALLATION ---
    - name: Update APT cache avec retries
      ansible.builtin.apt:
        update_cache: yes
      register: apt_update
      until: apt_update is success
      retries: 5
      delay: 10

    - name: Full Upgrade (dist-upgrade)
      ansible.builtin.apt:
        upgrade: dist

    - name: Installer Proxmox VE et PVE Headers
      ansible.builtin.apt:
        name: 
          - proxmox-ve
          - postfix
          - open-iscsi
          - pve-headers
        state: present
      notify: Reboot server

    # --- 5. NETTOYAGE (APRÈS INSTALLATION) ---
    - name: Supprimer le kernel Debian d'origine
      ansible.builtin.apt:
        name: linux-image-amd64
        state: absent
        purge: yes
      ignore_errors: yes

  handlers:
    - name: Reboot server
      ansible.builtin.reboot:
        reboot_timeout: 600
      when: reboot_enabled | bool
